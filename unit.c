#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include "shuff.h"

static int test8()
{
                                     /* RGBA */
    uint8_t packedref8[] = { 0x00, 0x01, 0x03, 0xFF, 0x00, 0x01, 0x03, 0xFF, 0x00, 0x01, 0x03, 0xFF, 0x00, 0x01, 0x03, 0xFF, 0x00, 0x01, 0x03, 0xFF, 0x80,
                             0x01, 0x03, 0x00, 0x80, 0x01, 0x03, 0x00, 0x80, 0x01, 0x03, 0x00, 0x80, 0x01, 0x03, 0x00, 0x80, 0x01, 0x03, 0x00, 0x80, 0x80,
                             0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x80 };
    uint8_t planarref8[] = { /* G */
                             0x01, 0x01, 0x01, 0x01, 0x01, 0x00,
                             0x03, 0x03, 0x03, 0x03, 0x03, 0x00,
                             0x10, 0x10, 0x10, 0x10, 0x10, 0x00,
                             /* B */
                             0x03, 0x03, 0x03, 0x03, 0x03, 0x00,
                             0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                             0x10, 0x10, 0x10, 0x10, 0x10, 0x00,
                             /* R */
                             0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                             0x01, 0x01, 0x01, 0x01, 0x01, 0x00,
                             0x10, 0x10, 0x10, 0x10, 0x10, 0x00,
                             /* A */
                             0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
                             0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
                             0x10, 0x10, 0x10, 0x10, 0x10, 0x00 };

    /*
     * RGBA  -> 0123
     * GBRAP -> 1203
     */
    ShuffMap map = {
        .planes  = { 0, 0, 0, 0 },
        .offsets = { 1, 2, 0, 3 }
    };

    ptrdiff_t instrides[4]  = { 21, 0, 0, 0 };
    ptrdiff_t outstrides[4] = {  6, 6, 6, 6 };

    uint8_t *inbufs[4]        = { &packedref8[0], NULL, NULL, NULL };
    uint8_t outbuf[6 * 3 * 4] = { 0 };
    uint8_t *outbufs[4]       = { &outbuf[0],
                                  &outbuf[6 * 3],
                                  &outbuf[6 * 3 * 2],
                                  &outbuf[6 * 3 * 3] };

    shuff_unpack_inline(&map, inbufs, instrides, outbufs, 4, outstrides, 5, 3, 1);

    if (memcmp(&planarref8[0], &outbuf[0], 6 * 3 * 4)) {
        printf("8-BIT RGBA -> GBRAP FAILED\n");
        return 1;
    }

    memset(outbuf, 0x80, 6 * 3 * 4);

    instrides[0]  = instrides[1] = instrides[2] = instrides[3] = 6;
    outstrides[0] = 21;
    outstrides[1] = 0;
    outstrides[2] = 0;
    outstrides[3] = 0;

    inbufs[0]  = &planarref8[0];
    inbufs[1]  = &planarref8[6 * 3];
    inbufs[2]  = &planarref8[6 * 3 * 2];
    inbufs[3]  = &planarref8[6 * 3 * 3];
    outbufs[0] = &outbuf[0];
    outbufs[1] = outbufs[2] = outbufs[3] = NULL;

    shuff_pack_inline(&map, inbufs, 4, instrides, outbufs, outstrides, 5, 3, 1);
    if (memcmp(&packedref8[0], &outbuf[0], 21 * 3)) {
        printf("8-BIT GBRAP -> RGBA FAILED\n");
        return 1;
    }

    return 0;
}

static int test16()
{
                                   /* RGB */
    uint8_t packedref16[] = { 0xAA, 0xAA, 0xBB, 0xBB, 0xCC, 0xCC, 0xAA, 0xAA, 0xBB, 0xBB, 0xCC, 0xCC, 0xAA, 0xAA, 0xBB, 0xBB, 0xCC, 0xCC, 0xAA, 0xAA, 0xBB, 0xBB, 0xCC, 0xCC, 0xAA, 0xAA, 0xBB, 0xBB, 0xCC, 0xCC, 0x80,
                              0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x80,
                              0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x80 };
    uint8_t planarref16[] = { /* G */
                              0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0x00,
                              0x33, 0x44, 0x33, 0x44, 0x33, 0x44, 0x33, 0x44, 0x33, 0x44, 0x00,
                              0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
                              /* B */
                              0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x00,
                              0x55, 0x66, 0x55, 0x66, 0x55, 0x66, 0x55, 0x66, 0x55, 0x66, 0x00,
                              0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
                              /* R */
                              0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00,
                              0x11, 0x22, 0x11, 0x22, 0x11, 0x22, 0x11, 0x22, 0x11, 0x22, 0x00,
                              0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00 };
    /*
     * RGB -> 012
     * GBR -> 120
     */
    ShuffMap map = {
        .planes  = { 0, 0, 0, 0 },
        .offsets = { 1, 2, 0, 0 }
    };

    ptrdiff_t instrides[4]  = { 31,  0,  0,  0 };
    ptrdiff_t outstrides[4] = { 11, 11, 11, 11 };

    uint8_t *inbufs[4]   = { &packedref16[0], NULL, NULL, NULL };
    uint8_t outbuf[11 * 3 * 3] = { 0 };
    uint8_t *outbufs[4]        = { &outbuf[0],
                                   &outbuf[11 * 3],
                                   &outbuf[11 * 3 * 2],
                                   NULL };

    shuff_unpack_inline(&map, inbufs, instrides, outbufs, 3, outstrides, 5, 3, 2);

    if (memcmp(&planarref16[0], &outbuf[0], 11 * 3 * 3)) {
        printf("16-BIT RGB -> GBRP FAILED\n");
        return 1;
    }

    memset(outbuf, 0x80, 11 * 3 * 3);

    instrides[0]  = instrides[1] = instrides[2] = 11;
    instrides[3]  = 0;
    outstrides[0] = 31;
    outstrides[1] = 0;
    outstrides[2] = 0;
    outstrides[3] = 0;

    inbufs[0]  = &planarref16[0];
    inbufs[1]  = &planarref16[11 * 3];
    inbufs[2]  = &planarref16[11 * 3 * 2];
    inbufs[3]  = NULL;
    outbufs[0] = &outbuf[0];
    outbufs[1] = outbufs[2] = outbufs[3] = NULL;

    shuff_pack_inline(&map, inbufs, 3, instrides, outbufs, outstrides, 5, 3, 2);
    if (memcmp(&packedref16[0], &outbuf[0], 31 * 3)) {
        printf("16-BIT GBRP -> RGB FAILED\n");
        return 1;
    }

    return 0;
}

int main()
{
    int ret = 0;

    ret |= test8();
    ret |= test16();

    return ret;
}
